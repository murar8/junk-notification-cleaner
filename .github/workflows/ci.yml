on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "*.*.*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write
      pull-requests: read
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Check code formatting
        run: npm run format:check
      - name: Run tests with coverage
        run: npm run test:coverage
      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          fail_ci_if_error: true
      - name: Build extension
        run: npm run build
      - name: Copy metadata to dist
        run: cp metadata.json dist/
      - name: Build GNOME Docker image
        uses: docker/build-push-action@v6
        with:
          tags: junk-notification-cleaner-uploader
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      - name: Pack extension
        run: >
          docker run --rm -v $(pwd):/app --workdir /app/dist junk-notification-cleaner-uploader
          gnome-extensions pack
          --force
          --extra-source=prefs.js
          --extra-source=isMatch.js
          --schema=../schemas/org.gnome.shell.extensions.junk-notification-cleaner.gschema.xml
      - name: Create password file
        run: |
          mkdir -p /tmp/password
          echo ${{ secrets.GNOME_EXTENSIONS_PASSWORD }} > /tmp/password/password.txt
      - name: Upload extension to GNOME Extensions
        if: github.event_name == 'push' && github.ref_type == 'tag'
        run: >
          docker run --rm --tty -v $(pwd):/app -v /tmp/password:/password --workdir /app/dist junk-notification-cleaner-uploader
          gnome-extensions upload junk-notification-cleaner@murar8.github.com.shell-extension.zip
          --accept-tos
          --user ${{ secrets.GNOME_EXTENSIONS_USER }}
          --password-file /password/password.txt
      - name: Delete password file
        if: always()
        run: rm -rf /tmp/password
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref_type == 'tag'
        with:
          fail_on_unmatched_files: true
          files: dist/junk-notification-cleaner@murar8.github.com.shell-extension.zip
          generate_release_notes: true
      - name: Create pre-release for CI build
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref_type != 'tag'
        with:
          fail_on_unmatched_files: true
          files: dist/junk-notification-cleaner@murar8.github.com.shell-extension.zip
          generate_release_notes: true
          prerelease: true
          tag_name: ci-build-${{ github.ref_name }}
